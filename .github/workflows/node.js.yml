name: Deploy Muscash

on:
  push:
    branches: ["master"]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install & Build
        run: |
          npm ci
          npm run build
          test -d dist || (echo "Folder 'dist' tidak ditemukan." && exit 1)

      # === setara: cd dist && tar cvzf ../dist.tar.gz * && cd ..
      - name: Package dist to dist.tar.gz
        run: tar -C dist -cvzf dist.tar.gz .

      - name: Install cloudflared
        run: |
          set -euxo pipefail
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cf.deb
          sudo dpkg -i cf.deb
          cloudflared --version

      # Install cloudflared & buka proxy lokal 127.0.0.1:2222 -> ssh.musyan.my.id
      - name: Start Cloudflare Access TCP proxy
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          CF_SSH_HOST: ssh.musyan.my.id
        run: |
          set -euxo pipefail
          # Jalankan proxy di background: localhost:2222 -> CF Access -> ssh.musyan.my.id
          cloudflared access tcp --hostname "$CF_SSH_HOST" --listener 127.0.0.1:2222 &
          # beri waktu untuk siap
          sleep 2

      # Siapkan SSH key + known_hosts agar StrictHostKeyChecking aman
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          PORT: ${{ secrets.PORT }}
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Tambahkan host key ke known_hosts (lebih aman daripada matikan StrictHostKeyChecking)
          ssh-keyscan -p "${PORT:-22}" "$HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # === setara: scp ./dist.tar.gz $user@$host:$path
      - name: Upload dist.tar.gz (scp)
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PORT: ${{ secrets.PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -e
          scp -P "${PORT:-22}" dist.tar.gz "$USERNAME@$HOST:$DEPLOY_PATH/"

      # === setara: ssh "cd $path && tar -xvzf $dist && rm -rf $dist"
      - name: Extract & clean on server (ssh)
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PORT: ${{ secrets.PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -e
          ssh -p "${PORT:-22}" "$USERNAME@$HOST" "
            set -e
            cd '$DEPLOY_PATH'
            tar -xvzf dist.tar.gz
            rm -f dist.tar.gz
          "